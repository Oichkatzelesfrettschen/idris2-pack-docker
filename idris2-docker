#!/bin/bash
# idris2-docker - Smart wrapper for Idris2 Pack Docker with state preservation
# Auto-detects podman/docker, supports local caching and state preservation

set -e

# Configuration
IMAGE_BASE="ghcr.io/oichkatzelesfrettschen/idris2-pack-docker"
IMAGE_TAG="${IDRIS2_TAG:-latest}"
IMAGE="${IMAGE_BASE}:${IMAGE_TAG}"
IDRIS_CACHE_DIR="${IDRIS_CACHE_DIR:-$HOME/.idris2-cache}"
IDRIS_WORKSPACE="${IDRIS_WORKSPACE:-$PWD}"

# Color output (disable with NO_COLOR=1)
if [ -t 1 ] && [ -z "${NO_COLOR:-}" ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

msg_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
msg_ok()    { echo -e "${GREEN}[OK]${NC} $*"; }
msg_warn()  { echo -e "${YELLOW}[WARN]${NC} $*" >&2; }
msg_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Auto-detect container runtime (prefer podman for lower overhead)
detect_runtime() {
    if command -v podman &>/dev/null; then
        # Check if podman is functional
        if podman info &>/dev/null 2>&1; then
            echo "podman"
            return
        fi
    fi
    if command -v docker &>/dev/null; then
        if docker info &>/dev/null 2>&1; then
            echo "docker"
        elif sudo docker info &>/dev/null 2>&1; then
            echo "sudo docker"
        else
            echo "docker-broken"
        fi
    else
        echo "none"
    fi
}

# Detect TTY for interactive mode
detect_tty_flags() {
    if [ -t 0 ] && [ -t 1 ]; then
        echo "-it"
    elif [ -t 1 ]; then
        echo "-i"
    else
        echo ""
    fi
}

RUNTIME=$(detect_runtime)
TTY_FLAGS=$(detect_tty_flags)

# Handle runtime detection failures with helpful messages
case "$RUNTIME" in
    none)
        msg_error "Neither podman nor docker is installed"
        echo "Install with:"
        echo "  Debian/Ubuntu: sudo apt install podman"
        echo "  Fedora/RHEL:   sudo dnf install podman"
        echo "  Arch:          sudo pacman -S podman"
        exit 1
        ;;
    docker-broken)
        msg_error "Docker is installed but not running or accessible"
        echo "Try:"
        echo "  1. Start Docker: sudo systemctl start docker"
        echo "  2. Add yourself to docker group: sudo usermod -aG docker \$USER"
        echo "  3. Log out and back in"
        exit 1
        ;;
esac

# Ensure cache directory exists
ensure_cache() {
    mkdir -p "$IDRIS_CACHE_DIR"/{pack-db,pack-config}
}

# Check if cache is initialized
cache_initialized() {
    [ -f "$IDRIS_CACHE_DIR/pack-db/HEAD.toml" ]
}

# Initialize cache from container (copies pack's package database)
init_cache() {
    echo "Initializing cache from container..."
    ensure_cache
    # Copy pack-db from container to local cache
    $RUNTIME run --rm -v "$IDRIS_CACHE_DIR:/cache" "$IMAGE" bash -c '
        cp -r /root/.local/state/pack/db/* /cache/pack-db/
        cp -r /root/.config/pack/* /cache/pack-config/ 2>/dev/null || true
    '
    echo "Cache initialized at $IDRIS_CACHE_DIR"
}

# Build volume mount arguments for state preservation
# Mounts initialized cache directories and workspace
build_cache_mounts() {
    echo "-v $IDRIS_CACHE_DIR/pack-db:/root/.local/state/pack/db -v $IDRIS_CACHE_DIR/pack-config:/root/.config/pack -v $IDRIS_WORKSPACE:/workspace"
}

# Build workspace-only mount (default, safe)
build_workspace_mount() {
    echo "-v $IDRIS_WORKSPACE:/workspace"
}

# Display help
show_help() {
    cat << EOF
idris2-docker - Smart wrapper for Idris2 Pack Docker

Runtime: $RUNTIME
Image: $IMAGE
Cache: $IDRIS_CACHE_DIR ($(cache_initialized && echo "initialized" || echo "not initialized"))

USAGE:
  idris2-docker [OPTIONS] COMMAND [ARGS...]

OPTIONS:
  --cached               Use initialized cache (must run --init-cache first)
  --fresh, --no-cache    Start with no mounts (clean container)
  --tag <tag>            Use specific image tag (default: latest)
  --init-cache           Initialize local cache from container
  --benchmark [mode]     Run benchmark (fresh or cached)
  --diagnose             Run diagnostics to check setup
  --info                 Show system and cache info
  --pull                 Pull latest image
  --clean                Remove all cached state

COMMANDS:
  shell         Interactive bash shell (default: workspace mounted)
  repl          Start Idris2 REPL
  build <ipkg>  Build a project
  pack <args>   Run pack commands
  idris2 <args> Run idris2 directly
  <default>     Pass through to container

ENVIRONMENT:
  IDRIS2_TAG        Image tag to use (default: latest)
  IDRIS_CACHE_DIR   Cache directory (default: ~/.idris2-cache)
  IDRIS_WORKSPACE   Workspace directory (default: current dir)
  NO_COLOR          Disable colored output

EXAMPLES:
  idris2-docker shell                     # Shell with workspace mounted
  idris2-docker --init-cache              # Initialize pack database cache
  idris2-docker --cached shell            # Shell with full cache mounts
  idris2-docker --fresh shell             # Clean container, no mounts
  idris2-docker --tag idris2-0.8 shell    # Use specific version
  idris2-docker pack install json         # Install package
  idris2-docker --diagnose                # Check setup
  IDRIS2_TAG=idris2-0.8 idris2-docker shell  # Alt version syntax
EOF
}

# Check if image is available locally
image_available() {
    $RUNTIME image exists "$IMAGE" 2>/dev/null || \
    $RUNTIME images -q "$IMAGE" 2>/dev/null | grep -q .
}

# Run container
run_container() {
    local mount_mode="workspace"  # workspace (default), cached, or fresh
    local cmd_args=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --cached)
                mount_mode="cached"
                shift
                ;;
            --fresh|--no-cache)
                mount_mode="fresh"
                shift
                ;;
            *)
                cmd_args+=("$1")
                shift
                ;;
        esac
    done

    # Check if image is available
    if ! image_available; then
        msg_warn "Image not found locally, pulling..."
        if ! $RUNTIME pull "$IMAGE"; then
            msg_error "Failed to pull image: $IMAGE"
            echo "Check your network connection or try:"
            echo "  idris2-docker --pull"
            exit 1
        fi
    fi

    local mounts=""
    case "$mount_mode" in
        cached)
            if ! cache_initialized; then
                msg_error "Cache not initialized"
                echo "Run: idris2-docker --init-cache"
                exit 1
            fi
            mounts=$(build_cache_mounts)
            ;;
        workspace)
            mounts=$(build_workspace_mount)
            ;;
        fresh)
            mounts=""
            ;;
    esac

    # shellcheck disable=SC2086
    $RUNTIME run --rm $TTY_FLAGS $mounts "$IMAGE" "${cmd_args[@]}"
}

# Show info
show_info() {
    echo "=== Idris2 Docker Info ==="
    echo "Runtime: $RUNTIME"
    echo "Image: $IMAGE"
    echo "Image available: $(image_available && echo 'yes' || echo 'no')"
    echo "Cache dir: $IDRIS_CACHE_DIR"
    echo "Cache initialized: $(cache_initialized && echo 'yes' || echo 'no')"
    echo "Workspace: $IDRIS_WORKSPACE"
    echo "TTY mode: ${TTY_FLAGS:-none}"
    echo ""
    echo "=== Cache sizes ==="
    if [ -d "$IDRIS_CACHE_DIR" ]; then
        du -sh "$IDRIS_CACHE_DIR"/* 2>/dev/null || echo "Empty cache"
    else
        echo "No cache directory yet"
    fi
    echo ""
    echo "=== Container image ==="
    $RUNTIME images "$IMAGE" 2>/dev/null || echo "Image not pulled yet"
}

# Run diagnostics
run_diagnostics() {
    echo "=== Idris2 Docker Diagnostics ==="
    echo ""

    # Runtime check
    echo "1. Container Runtime"
    echo "   Detected: $RUNTIME"
    if [ "$RUNTIME" = "podman" ]; then
        echo "   Version: $(podman --version 2>/dev/null || echo 'unknown')"
    elif [ "$RUNTIME" = "docker" ]; then
        echo "   Version: $(docker --version 2>/dev/null || echo 'unknown')"
    fi
    msg_ok "Runtime OK"
    echo ""

    # Image check
    echo "2. Container Image"
    echo "   Image: $IMAGE"
    if image_available; then
        msg_ok "Image available locally"
        local img_size
        img_size=$($RUNTIME images --format "{{.Size}}" "$IMAGE" 2>/dev/null | head -1)
        echo "   Size: ${img_size:-unknown}"
    else
        msg_warn "Image not available locally"
        echo "   Run: idris2-docker --pull"
    fi
    echo ""

    # Cache check
    echo "3. Cache Directory"
    echo "   Path: $IDRIS_CACHE_DIR"
    if [ -d "$IDRIS_CACHE_DIR" ]; then
        if cache_initialized; then
            msg_ok "Cache initialized"
            local db_files
            db_files=$(find "$IDRIS_CACHE_DIR/pack-db" -name "*.toml" 2>/dev/null | wc -l)
            echo "   Package database files: $db_files"
        else
            msg_warn "Cache directory exists but not initialized"
            echo "   Run: idris2-docker --init-cache"
        fi
    else
        msg_info "Cache directory not created yet"
    fi
    echo ""

    # Workspace check
    echo "4. Workspace"
    echo "   Path: $IDRIS_WORKSPACE"
    if [ -d "$IDRIS_WORKSPACE" ]; then
        if [ -w "$IDRIS_WORKSPACE" ]; then
            msg_ok "Workspace writable"
        else
            msg_error "Workspace not writable"
        fi
        local ipkg_count
        ipkg_count=$(find "$IDRIS_WORKSPACE" -maxdepth 2 -name "*.ipkg" 2>/dev/null | wc -l)
        if [ "$ipkg_count" -gt 0 ]; then
            echo "   Found $ipkg_count .ipkg file(s)"
        fi
    else
        msg_error "Workspace directory does not exist"
    fi
    echo ""

    # Quick container test
    echo "5. Container Test"
    if image_available; then
        echo "   Testing idris2 --version..."
        if timeout 30 $RUNTIME run --rm "$IMAGE" idris2 --version 2>/dev/null; then
            msg_ok "Container working"
        else
            msg_error "Container test failed"
        fi
    else
        msg_warn "Skipping (image not available)"
    fi
    echo ""

    echo "=== Diagnostics Complete ==="
}

# Benchmark
run_benchmark() {
    local mode="${1:-cached}"
    echo "=== Idris2 Pure Benchmark ==="
    echo "Runtime: $RUNTIME"
    echo "Mode: $mode"
    echo ""

    local mounts=""
    if [ "$mode" = "cached" ]; then
        ensure_cache
        mounts=$(build_cache_mounts)
    else
        mounts="-v /tmp:/workspace"
    fi

    echo "--- Test 1: idris2 --version (cold start) ---"
    # shellcheck disable=SC2086
    time $RUNTIME run --rm $mounts "$IMAGE" idris2 --version

    echo ""
    echo "--- Test 2: pack help (runtime check) ---"
    # shellcheck disable=SC2086
    time $RUNTIME run --rm $mounts "$IMAGE" pack help >/dev/null

    echo ""
    echo "--- Test 3: Compile & run Hello World ---"
    # shellcheck disable=SC2086
    time $RUNTIME run --rm $mounts "$IMAGE" bash -c '
        cd /workspace
        mkdir -p benchmark_test && cd benchmark_test
        cat > hello.idr << IDRIS
module Main
main : IO ()
main = putStrLn "Hello from benchmark!"
IDRIS
        idris2 hello.idr -o hello
        ./build/exec/hello
        cd .. && rm -rf benchmark_test
    '

    echo ""
    echo "=== Benchmark complete ==="
}

# Clean cache
clean_cache() {
    if [ -d "$IDRIS_CACHE_DIR" ]; then
        echo "Removing cache at $IDRIS_CACHE_DIR..."
        rm -rf "$IDRIS_CACHE_DIR"
        echo "Done."
    else
        echo "No cache to clean."
    fi
}

# Main
case "${1:-}" in
    --help|-h|help)
        show_help
        ;;
    --info|info)
        show_info
        ;;
    --diagnose|diagnose)
        run_diagnostics
        ;;
    --pull|pull)
        msg_info "Pulling $IMAGE..."
        $RUNTIME pull "$IMAGE"
        msg_ok "Image pulled successfully"
        ;;
    --tag)
        # Handle --tag <tag> <command>
        if [ -z "${2:-}" ]; then
            msg_error "--tag requires a tag argument"
            echo "Usage: idris2-docker --tag <tag> <command>"
            echo "Example: idris2-docker --tag idris2-0.8 shell"
            exit 1
        fi
        IMAGE_TAG="$2"
        IMAGE="${IMAGE_BASE}:${IMAGE_TAG}"
        shift 2
        # Re-run with remaining args
        exec "$0" "$@"
        ;;
    --init-cache)
        init_cache
        ;;
    --clean|clean)
        clean_cache
        ;;
    --benchmark|benchmark)
        run_benchmark "${2:-fresh}"
        ;;
    --cached)
        shift
        run_container --cached "${@:-bash}"
        ;;
    --fresh|--no-cache)
        shift
        run_container --fresh "${@:-bash}"
        ;;
    shell)
        shift
        run_container bash "$@"
        ;;
    repl)
        shift
        run_container idris2 "$@"
        ;;
    build)
        shift
        run_container idris2 --build "$@"
        ;;
    pack)
        shift
        run_container pack "$@"
        ;;
    idris2)
        shift
        run_container idris2 "$@"
        ;;
    "")
        show_help
        ;;
    *)
        run_container "$@"
        ;;
esac
